{% extends "base.html" %}

{% block title %}Import/Export CSV - Finance Tracker{% endblock %}

{% block content %}
<div class="csv-page">
    <h1>üìä Import & Export Transactions</h1>

    <div class="csv-container">
        <!-- Export Section -->
        <div class="section">
            <h2>üì• Export to CSV</h2>
            <p>Download all your transactions as a CSV file for backup or analysis.</p>
            <button id="exportBtn" class="btn btn-primary">‚¨áÔ∏è Download CSV</button>
            <div id="exportMessage" class="form-message" style="display: none; margin-top: 1rem;"></div>
        </div>

        <!-- Import Section -->
        <div class="section">
            <h2>üì§ Import from CSV</h2>
            <p>Upload a CSV file to import transactions. Expected columns: <code>type, category, amount, date</code></p>
            
            <div class="import-form-container">
                <form id="csvImportForm" class="csv-form">
                    <div class="form-group">
                        <label for="csvFile">Select CSV File *</label>
                        <input type="file" id="csvFile" name="csvFile" accept=".csv" required>
                        <small>File must be in CSV format with columns: type, category, amount, date (optional)</small>
                    </div>
                    <button type="submit" class="btn btn-primary">üì§ Import Transactions</button>
                </form>
                <div id="importMessage" class="form-message" style="display: none;"></div>
            </div>

            <!-- CSV Format Guide -->
            <div class="csv-guide">
                <h3>üìã CSV Format Guide</h3>
                <p><strong>Required columns:</strong></p>
                <ul>
                    <li><code>type</code> - "income" or "expense"</li>
                    <li><code>category</code> - Transaction category (e.g., Food, Salary, Rent)</li>
                    <li><code>amount</code> - Numeric value in Ksh</li>
                </ul>
                <p><strong>Optional columns:</strong></p>
                <ul>
                    <li><code>date</code> - Transaction date (YYYY-MM-DD or YYYY-MM-DD HH:MM:SS). If omitted, current date is used.</li>
                </ul>
                <p><strong>Example:</strong></p>
                <pre>type,category,amount,date
income,Salary,50000,2025-11-01
expense,Food,2500,2025-11-05 14:30:00
expense,Rent,10000,2025-11-10
income,Bonus,5000</pre>

                <h3>üîÑ Sample Export</h3>
                <p>Click "Download CSV" above to see the format of exported data. You can edit it and re-import.</p>
            </div>
        </div>
    </div>
</div>

<style>
    .csv-page {
        max-width: 900px;
        margin: 0 auto;
    }

    .csv-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    .section {
        background: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
        margin-bottom: 1rem;
        color: #1F2937;
    }

    .section p {
        color: #6B7280;
        margin-bottom: 1.5rem;
    }

    .import-form-container {
        background: #F9FAFB;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .csv-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .csv-form .form-group {
        display: flex;
        flex-direction: column;
    }

    .csv-form label {
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .csv-form input[type="file"] {
        padding: 0.75rem;
        border: 2px dashed #D1D5DB;
        border-radius: 0.5rem;
        cursor: pointer;
    }

    .csv-form small {
        font-size: 0.875rem;
        color: #6B7280;
        margin-top: 0.25rem;
    }

    .csv-guide {
        background: #F0F9FF;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border-left: 4px solid #1E3A8A;
    }

    .csv-guide h3 {
        margin-top: 1rem;
        margin-bottom: 0.75rem;
        color: #1F2937;
    }

    .csv-guide h3:first-child {
        margin-top: 0;
    }

    .csv-guide ul {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
        color: #374151;
    }

    .csv-guide li {
        margin-bottom: 0.5rem;
    }

    .csv-guide code {
        background: #FFFFFF;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        color: #1E3A8A;
    }

    .csv-guide pre {
        background: #FFFFFF;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #D1D5DB;
        overflow-x: auto;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .csv-page {
            padding: 1rem;
        }

        .section {
            padding: 1.5rem;
        }

        .csv-guide {
            padding: 1rem;
        }
    }
</style>

<script>
    // Export CSV
    document.getElementById('exportBtn').addEventListener('click', async () => {
        try {
            const response = await fetch('{{ url_for("api_export_csv") }}');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `transactions_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            showMessage('exportMessage', '‚úÖ CSV file downloaded successfully!', 'success');
        } catch (error) {
            showMessage('exportMessage', '‚ùå Error downloading CSV: ' + error.message, 'error');
        }
    });

    // Import CSV
    document.getElementById('csvImportForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];

        if (!file) {
            showMessage('importMessage', '‚ùå Please select a file', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('{{ url_for("api_import_csv") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showMessage('importMessage', `‚úÖ ${data.message}`, 'success');
                fileInput.value = '';
                
                // Reload page after 2 seconds to show new transactions
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showMessage('importMessage', `‚ùå ${data.message}`, 'error');
            }
        } catch (error) {
            showMessage('importMessage', '‚ùå Error: ' + error.message, 'error');
        }
    });

    function showMessage(elementId, message, type) {
        const messageDiv = document.getElementById(elementId);
        messageDiv.className = `form-message ${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';

        // Auto-hide after 5 seconds for success messages
        if (type === 'success') {
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
    }
</script>
{% endblock %}
